name: Sync Confluence Docs

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - "docs/confluence-functional-technical.storage.html"
      - "docs/confluence-technical.storage.html"
      - "docs/confluence-netsuite-sales-estimate.storage.html"
      - "docs/confluence-setup-guide.storage.html"
      - "docs/inventory-api.md"
      - "docs/openapi.yaml"
      - "README.md"
      - "backend/server.mjs"
      - "src/App.jsx"

jobs:
  sync-confluence:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Validate required Confluence secrets
        env:
          CONFLUENCE_BASE_URL: ${{ secrets.CONFLUENCE_BASE_URL }}
          CONFLUENCE_EMAIL: ${{ secrets.CONFLUENCE_EMAIL }}
          CONFLUENCE_API_TOKEN: ${{ secrets.CONFLUENCE_API_TOKEN }}
        run: |
          if [ -z "$CONFLUENCE_BASE_URL" ] || [ -z "$CONFLUENCE_EMAIL" ] || [ -z "$CONFLUENCE_API_TOKEN" ]; then
            echo "Missing required secrets: CONFLUENCE_BASE_URL, CONFLUENCE_EMAIL, CONFLUENCE_API_TOKEN"
            exit 1
          fi

      - name: Publish Functional + Technical page
        env:
          CONFLUENCE_BASE_URL: ${{ secrets.CONFLUENCE_BASE_URL }}
          CONFLUENCE_EMAIL: ${{ secrets.CONFLUENCE_EMAIL }}
          CONFLUENCE_API_TOKEN: ${{ secrets.CONFLUENCE_API_TOKEN }}
        run: |
          node scripts/confluence-upsert.mjs \
            --space SAD \
            --title "Test: AI functional and technical documentation" \
            --file docs/confluence-functional-technical.storage.html \
            --parent 3109715969

      - name: Publish Technical page
        env:
          CONFLUENCE_BASE_URL: ${{ secrets.CONFLUENCE_BASE_URL }}
          CONFLUENCE_EMAIL: ${{ secrets.CONFLUENCE_EMAIL }}
          CONFLUENCE_API_TOKEN: ${{ secrets.CONFLUENCE_API_TOKEN }}
        run: |
          node scripts/confluence-upsert.mjs \
            --space SAD \
            --title "Test: AI Technical documentation" \
            --file docs/confluence-technical.storage.html \
            --parent 3109715969

      - name: Publish Setup Guide page
        env:
          CONFLUENCE_BASE_URL: ${{ secrets.CONFLUENCE_BASE_URL }}
          CONFLUENCE_EMAIL: ${{ secrets.CONFLUENCE_EMAIL }}
          CONFLUENCE_API_TOKEN: ${{ secrets.CONFLUENCE_API_TOKEN }}
        run: |
          node scripts/confluence-upsert.mjs \
            --space SAD \
            --title "Test: AI GitHub to Confluence automation setup guide" \
            --file docs/confluence-setup-guide.storage.html \
            --parent 3109715969

      - name: Publish NetSuite Sales Estimate Design page
        env:
          CONFLUENCE_BASE_URL: ${{ secrets.CONFLUENCE_BASE_URL }}
          CONFLUENCE_EMAIL: ${{ secrets.CONFLUENCE_EMAIL }}
          CONFLUENCE_API_TOKEN: ${{ secrets.CONFLUENCE_API_TOKEN }}
        run: |
          node scripts/confluence-upsert.mjs \
            --space SAD \
            --title "Test: AI NetSuite sales estimate integration design" \
            --file docs/confluence-netsuite-sales-estimate.storage.html \
            --parent 3109715969
